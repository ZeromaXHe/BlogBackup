# 第1章 DDD对我而言

领域驱动设计（DDD）

## 1.3 战略设计

在展开具体实现细节之前，需要优先完成宏观层面的战略设计。它强调的是业务战略上的重点，如何按重要性分配工作，以及如何进行最佳整合。

首先，你需要学会运用名为**限界上下文（Bounded Context）**的战略设计模式来分离领域模型。紧接着，你会了解如何使用在明确的**限界上下文**中发展一套领域模型的**通用语言（Ubiquitous Language）**。

当进一步深入到战略设计中时，将会学到**子域（Subdomain）**，并了解如何通过它处理遗留系统中无边界的复杂性，以及如何改进新项目上的成果。还会了解如何通过名为**上下文映射（Context Maping）**的技术来集成多个限界上下文。**上下文映射图（Context map）**同时定义了两个进行集成的**限界上下文**之间的团队间关系及技术实现方式。

## 1.4 战术设计

在打好战略设计的基础之后，将会发现 DDD 最为突出的莫过于战术层面的设计工具。其中之一比较重要的工具被用来将若干实体和值对象以恰当的大小聚集在一起。这就是**聚合（Aggregate）**模式。

DDD 就是以最明确而又可行的方式对领域进行建模。使用**领域事件（Domain Events）**既可以让你明确地建立模型，也可把模型内部发生的事情分享给需要知道这一切的系统。这些相关的系统可能是你自己的本地**限界上下文**和其他的远程**限界上下文**。

# 第2章 运用限界上下文与通用语言进行战略设计

什么是**限界上下文（Bounded Context）**？什么又是**通用语言（Ubiquitous Language）**？简单地说，DDD 主要关注的是如何在明确的**限界上下文**中创建**通用语言**的模型。这种方法虽然没有错，但可能不是最清晰的描述。让我进一步解释一下这些概念。

首先，**限界上下文**是语义和语境上的边界。这意味着边界内的每个代表软件模型的组件都有着特定的含义并处理特定的事务。**限界上下文**中的这些组件有特定的上下文语境和语义理据。

如果刚刚开始投入到软件建模中，**限界上下文**多少是有些概念化的。你可以将它理解为**问题空间（Problem Space）**的一部分。然而，随着软件模型开始呈现出更深层次以及更清晰的含义时，**限界上下文**将会被迅速转换到**解决方案空间（Solution Space）**中，同时软件模型将通过项目的源代码来实现。请记住，模型是在**限界上下文**中实现的，你也将会为每个**限界上下文**开发出不同的软件。

>**什么是问题空间和解决方案空间？**
>
>问题空间是在给定项目的约束条件下进行高级战略分析与设计各个步骤的地方。
>
>解决方案空间就是真正实施解决方案的地方，这些解决方案在问题空间讨论中被识别为**核心域**（Core Domain）。当限界上下文被当作组织的关键战略举措进行开发时，即被成为核心域。

团队在**限界上下文**中发展了一种语言用于表达其边界内的软件模型，这一语言由在该**限界上下文**中开发软件模型的每个团队成员所使用。它之所以被称之为**通用语言（Ubiquitous Language）**，是因为团队成员间交流用的是它，软件模型实现的也是它。因此，**通用语言**必须严谨、精确，并且紧凑。当**限界上下文**被当作组织的关键战略举措进行开发时，即被称之为**核心域**。

> **限界上下文、团队和源代码仓库**
>
> 一个团队应该在一个限界上下文中工作。每个限界上下文应该拥有一个独立的源代码仓库。一个团队可能工作在多个限界上下文中，但是多个团队不应该在同一个限界上下文中共事。

如果没有使用限界上下文，因为这样或那样的错误，团队常常会将全新的软件产品变成一个所谓的**大泥球（Big Ball of Mud）**。

## 2.1 领域专家和业务驱动

业务部门或工作组织的划分可以很好地标明模型边界的位置。

当你意识到不同业务领域对同一术语可能有不同的定义时，就可以肯定这种分离是必要的。

DDD 强调将这些不同的概念类型分离到不同的**限界上下文**中，以此来拥抱这些差异，并且承认存在不同的**通用语言**和与之对应的职能。

## 2.3 战略设计是必要的根基

DDD 中有哪些工具可以帮助我们避免这些陷阱？你至少需要两种基本的战略设计工具，**限界上下文**和**通用语言**。采用**限界上下文**会迫使我们回答“什么是核心？”的问题。它应紧紧地抓住战略举措中所有的核心概念，并排除其他概念，剩下的都应该是团队**通用语言**的一部分。

然而，我们该如何确定核心？为此，我们必须将两个重要的群体——**领域专家（Domain Expert）**和软件开发人员，整合成一个有凝聚力的协作团队。

**领域专家**自然会更加关注业务问题。他们的想法会集中在组织如何运作的愿景上。

> **产品负责人还是领域专家？**
>
> 在某些情况下，他们可能是同一个人。产品负责人常常更加关注管理和产品待办项的优先级顺序，并时刻留意着项目的概念和技术是否保持着连续性。但这不意味着产品负责人天生就是领域内的业务核心竞争力方面的专家。我们要确保团队中有真正的领域专家，还要避免让缺乏必要专业技能的产品负责人代替领域专家。

在 DDD 项目的实施过程中，开发人员需要尽量克制这种“以技术为中心”的冲动，以防无法接受以业务为中心的核心战略举措。相反开发人员应当抛弃任何多余的技术洁癖，并拥抱团队在特定**限界上下文**中逐步发展的**通用语言**。

> **专注业务复杂性而非技术复杂性**
>
> 之所以会采用 DDD，是因为业务模型的高度复杂。我们从未想过让领域模型比其更复杂。不过，也正是因为业务模型比项目的技术特性更加复杂，我们才会使用 DDD。这也是开发人员必须与领域专家一起深入钻研业务模型的原因。

开发人员和**领域专家**都应该拒绝任何以文档为主要交流手段的倾向。最佳的**通用语言**是通过协作反馈循环而发展出来的，从中可以促成团队形成共同的心智模型。对当前知识领域的开放式讨论、探索和质疑都会深化团队对于核心域的认知。

## 2.5 发展通用语言

我们不要将**核心域**局限在名词上。相反，应当使用一组具体场景来表达**核心域**，这些场景描述了领域模型应该做的事情。本书所定义的场景，其真正含义是领域模型该如何工作，各种组件该做什么。

### 2.5.1 应用场景

你可能想知道如何把书面场景转换成某种可以用来验证领域模型是否符合团队需求说明的产出物。可以采用一种被称为**实例化需求[Specification]**的技术，它也被称为**行为驱动开发[BDD]**。你期望通过这些方法达到这些效果：协作发展并完善**通用语言**、团队共识建模，以及确定模型是否符合需求说明的需求。我们通过创建验收测试来达到这些效果。

“假如/当/那么（Given/When/Then）”的场景编写方式比之前的例子要好。

你并非一定要使用这种形式的可执行需求说明来验证场景与领域模型是否一致。你也可以使用单元测试框架来达成同样的目标，通过它创建验收测试（不是单元测试）来验证领域模型。

### 2.5.2 如何持续

事实上，最佳的学习方式，即知识获取，将在一段很长的时间持续发生，甚至发生在所谓的“维护期”。

最糟糕的情况可能是给**核心域**贴上“维护阶段”的标签。持续学习的过程根本不是一个阶段。早期发展的**通用语言**必定随着岁月的流逝而不断成长。

## 2.6 架构

**限界上下文**内会有什么？当使用**端口（Port）**和**适配器（Adapter）**的架构图时，你会发现**限界上下文**的组成绝不仅仅只是一个领域模型。

下面这些层次在**限界上下文**中很常见：

- **输入适配器（Input Adapter）**，例如用户界面控制器、REST 终端节点和消息监听器。
- 编排用例和管理事务的**应用服务（Application Service）**
- 我们一直关注的领域模型
- 还有**输出适配器（Output Adapter）**，如持久化管理和消息发送器。

我们可以使用端口和适配器作为一种基础架构，但这不是在 DDD 中唯一可用的架构。除了端口和适配器，你可以在 DDD 中使用任何架构，或架构模型（或是其他），并可以根据需要进行匹配或是混合使用。

- 事件驱动架构，**事件溯源**。在本书第 6 章中将会讨论事件溯源。
- 命令与查询职责分离（CQRS）。
- 响应式架构和 Actor 模型
- 具象状态传输（REST）
- 面向服务的架构（SOA）
- 《微服务设计》一书中解释了微服务本质上等同于 DDD 中的限界上下文
- 云计算和微服务以一样的方式得到支持

# 第3章 运用子域进行战略设计

DDD 项目中总会碰到很多**限界上下文（Bounded Contexts）**。这些上下文中一定有一个将成为**核心域（Core Domain）**，而其他的限界上下文之中也会存在许多不同的**子域（Sub Domain）**。正是因为采用了 DDD 的战略设计，团队方能实现最佳的建模成果：**限界上下文**与**子域**之间一一对应。换句话说，敏捷项目管理核心即一个清晰的**限界上下文**，也是一个清晰的**子域**。在某些情况下，一个**限界上下文**中有可能存在多个子域，但这并非是最理想的建模结果。

## 3.1 什么是子域

简单地说，**子域**是整个业务领域的一部分。你可以认为**子域**代表的是一个单一的、有逻辑地领域模型。大多数的业务领域都过于庞大和复杂，难以作为整体来分析，因此我们一般只关心那些必须在单个项目中涉及的**子域**。**子域**可以用来逻辑地拆分整个业务领域，这样才能理解存在于大型复杂项目中的**问题空间**。

也可以认为**子域**是一个明确的专业领域，假设它负责为核心业务提供解决方案。这意味着特定的**子域**将会有一位或多位**领域专家**领衔，他们非常了解由这些特定**子域**促成的业务的方方面面。对你的业务而言，**子域**也有或多或少的战略意义。

如果通过 DDD 来创建**子域**，它将会被实现成一个清晰的**限界上下文**。特定业务的**领域专家**将会成为共建**限界上下文**团队的一员。

## 3.2 子域类型

项目中有三种主要的子域类型：

- **核心域（Core Domain）**：它是一个唯一的、定义明确的领域模型，要对它进行战略投资，并在一个明确的**限界上下文**中投入大量资源去精心打磨**通用语言**。它是组织中最重要的项目，因为这将是你与其他竞争者的区别所在。正是因为你的组织无法在所有领域都出类拔萃，所以必须把**核心域**打造成组织的核心竞争力。做出这样的决定需要对**核心域**进行深入的学习与理解，而这需要承诺、协作与试验。这时组织最需要在软件中倾斜其投资的方向。后面的章节中会提供加速与高效管理这些项目的方法。
- **支撑子域（Supporting Subdomain）**：这类建模场景提倡的是“定制开发”，因为找不到现成的解决方案。对它的投入无论如何也达不到与**核心域**相同的程度。也许会考虑使用外包的方式实现此类**限界上下文**，以避免因错误地认为其具有战略意义而进行巨额的投资。这类软件模型仍旧非常重要，**核心域**的成功离不开它。
- **通用子域（Generic Subdomain）**：**通用子域**的解决方案可以采购现成的，也可以采用外包的方式，抑或是由内部团队实现，但我们不用为其分配与核心域同样优质的研发资源，甚至都不如**支撑子域**。请注意不要把通用子域误认为是核心域。我们并不希望对其投资过甚。当讨论一个正在实施 DDD 的项目时，最有可能讨论的是核心域。

## 3.3 应对复杂性

业务领域中的某些系统边界将非常可能是遗留系统，它们也许是由你的组织构建的，也许是通过购买软件许可的方式获得的。此时，可能无法对这些遗留系统进行任何改造，但当它们对**核心域**产生影响时，就需要我们认真对待。为此，**子域**可以作为讨论**问题空间**的工具。

不幸的是，事与愿违，有些遗留系统与强调**限界上下文**的 DDD 设计方式大相径庭，甚至可以称之为 **无边界（unbounded）**遗留系统。这样的遗留系统正是我提到的“**大泥球**”。事实上，“**大泥球**”内充满了多个错综复杂的模型，这些模型本应被分别设计并实现，但当它们纠缠在一起时，整个系统会乱成一团。

如果使用分开的**通用语言**思考，可能遗留系统就不会成为单体**大泥球**，这至少也可以帮助我们理解如何与它进行集成。使用**子域**来思考和讨论此类遗留系统有助于我们应对大型错综复杂模型的残酷现实。当使用这类工具时，我们可以明确那些对业务更有价值、对项目更重要的**子域**，而其他子域可以降低到次要位置。

当使用 DDD 时，**限界上下文**应该与**子域**一一对应（1：1）。也就是说，如果存在一个**限界上下文**，那么它的目标就应该是对应且只对应一个**子域**模型。想要始终做到这一点很难，但在可能的前提下，尽量以这种方式去建模很重要。这样可以使**限界上下文**清晰并且始终专注于核心战略举措。

如果必须在同一个**限界上下文**（**核心域**）中创建第二个模型，应该使用一个完全独立的模块将该模型从核心域中分离出来（DDD 的**模块**基本上等同于 Scala 和 Java 中的包，或者是 F# 和 C# 的命令空间）。DDD 通过清晰的语言声明了一个模型是核心，而另一个只是它的支撑。我们可以在**解决方案空间**中使用分离**子域**这种特殊方法。

# 第4章 运用上下文映射进行战略设计