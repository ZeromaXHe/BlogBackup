# 从浏览器输入 URL 后到页面显示的流程

# 简答

以下为计算机网络应用层到网络层的流程：

1. 浏览器分析链接所指向页面的 URL。
2. 浏览器向 DNS 请求解析 URL 的 IP 地址。
3. 域名系统 DNS 解析出 URL 对应的服务器 IP 地址。
4. 浏览器与该服务器建立 TCP 连接（默认端口号为 80）。
5. 浏览器发出 HTTP 请求。
6. 服务器通过 HTTP 响应把 html 文件发送给浏览器。
7. 释放 TCP 连接。
8. 浏览器解析 html 文件，并将 Web 页显示给用户。

# 详解

## 应用层到网络层的解析

在浏览器中输入 URL 并按回车，直到页面显示在浏览器中，在此过程中，按照 TCP/IP 参考模型，从应用层到网络层都用到了哪些协议？

- **应用层**。HTTP：WWW 访问协议；DNS：域名解析服务。
- **传输层**。TCP：为HTTP 提供可靠的数据传输；UDP：DNS 使用 UDP 传输。
- **网络层**。 IP： IP 包传输和路由选择；ICMP：提供网络传输中的差错检测；ARP：将本机的默认网关 IP 地址映射成物理 MAC 地址。

### 超文本传输协议（HTTP）

HTTP 定义了浏览器（万维网客户进程）怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。从层次的角度看，HTTP 是面向事务的（Transaction-oriented）应用层协议，它规定了在浏览器和服务器之间的请求和响应的格式与规则，是万维网上能够可靠地交换文件的重要基础。

用户单击鼠标后所发生的事件按顺序如下：

1. 浏览器分析链接所指向页面的 URL。
2. 浏览器向 DNS 请求解析 URL 的 IP 地址。
3. 域名系统 DNS 解析出 URL 对应的服务器 IP 地址。
4. 浏览器与该服务器建立 TCP 连接（默认端口号为 80）。
5. 浏览器发出 HTTP 请求。
6. 服务器通过 HTTP 响应把 html 文件发送给浏览器。
7. 释放 TCP 连接。
8. 浏览器解析 html 文件，并将 Web 页显示给用户。

### 域名系统（DNS）

域名系统（Domain Name System，DNS）是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名转换为便于机器处理的 IP 地址。

DNS 系统采用客户/服务器模型，其协议运行在 UDP 之上，使用 53 号端口。

域名解析是指把域名映射成为 IP 地址或把 IP 地址映射成域名的过程。前者称为**正向解析**，后者称为**反向解析**。当客户端需要域名解析时，通过本机的 DNS 客户端构造一个 DNS 请求报文，以 UDP 数据报方式发往本地域名服务器。

域名解析有两种方式：递归查询和递归与迭代相结合的查询。

递归查询的过程，本地域名服务器只需向根域名服务器查询一次，后面的几次查询都是递归地在其他几个域名服务器之间进行的。由于该方法给根服务器造成的负载过大，所以在实际中几乎不使用。

常用递归和迭代相结合的查询方式，该方式分为两个部分。

1. 主机向本地域名服务器的查询采用的是递归查询

   也就是说，如果本地主机所询问的本地域名服务器不知道被查询域名的 IP 地址，那么本地域名服务器就以 DNS 客户的身份，向根域名服务器继续发出查询请求报文（即替该主机继续查询），而不是让该主机自己进行下一步的查询。两种查询方式的这一步是相同的。

2. 本地域名服务器向根域名服务器的查询采用迭代查询

   当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的 IP 地址，要么告诉本地域名服务器下一步应该向哪个顶级域名服务器进行查询。然后让本地域名服务器向这个顶级域名服务器进行后续的查询。
   同样，顶级域名服务器收到查询报文后，要么给出所要查询的 IP 地址，要么告诉本地域名服务器下一步应向哪个权限域名服务器查询。最后，知道所要解析的域名的 IP 地址后，把这个结果返回给发起查询的主机。

为了提高 DNS 的查询效率，并减少因特网上的 DNS 查询报文数量，在域名服务器中广泛地使用了高速缓冲。

当一个 DNS 服务器接收到 DNS 查询结果时，它能将该 DNS 信息缓存在高速缓存中。这样，当另一个相同的域名查询到达该 DNS 服务器时，该服务器就能够直接提供所要求的 IP 地址，而不需要再去向其他 DNS 服务器询问。

因为主机名和 IP 地址之间的映射不是永久的，所以 DNS 服务器将在一段时间后丢弃高速缓存中的信息。

## 计算机网络角度的细节全流程解析

我们的场景：一名学生 Bob 将他的便携机与学校的以太网交换机相连，下载一个 Web 页面。

### 准备：DHCP、UDP、IP 和以太网

我们假定 Bob 启动他的便携机，然后将其用一根以太网电缆连接到学校的以太网交换机，交换机又与学校的路由器相连。学校的这台路由器与一个 ISP 连接，本例中 ISP 为 comcast.net。

在本例中，comcast.com 为学校提供了 DNS 服务；所以，DNS 服务器驻留在 Comcast 网络中。我们将假设 DHCP 服务器运行在路由器中，就像常见情况那样。

当 Bob 首先将便携机与网络连接时，没有 IP 地址他就不能做任何事情（例如下载一个 Web 网页）。所以，Bob 的便携机所采取的一个网络相关的动作是运行 DHCP 协议，以从本地 DHCP 服务器获得一个 IP 地址以及其他信息。

1. Bob 便携机上的操作系统生成一个 **DHCP 请求报文**，并将这个报文放入具有目的地端口67（DHCP服务器）和源端口69（DHCP客户）的 **UDP 报文段**。该 UDP 报文段则被放置在一个具有广播 IP 目的地地址（255.255.255.255）和源 IP 地址 0.0.0.0 的 **IP 数据报**中，因为 Bob 的便携机还不具有一个 IP 地址。
2. 包含 DHCP 请求报文的 IP 数据报则被放置在**以太网帧**中。该以太网帧具有目的 MAC 地址 FF:FF:FF:FF:FF:FF，使该帧将广播到与交换机连接的所有设备（如果顺利的话也包括 DHCP 服务器）；该帧的源 MAC 地址是 Bob 便携机的 MAC 地址 00:16:D3:23:68:8A。
3. 包含 DHCP 请求的广播以太网帧是第一个由 Bob 便携机发送到以太网交换机的帧。该交换机在所有的出端口广播入帧，包括连接到路由器的端口。
4. 路由器在它的具有 MAC 地址 00:22:6B:45:1F 的接口接收到该广播以太网帧，该帧中包含 DHCP 请求，并且从该以太网帧中抽取出 IP 数据报。该数据报的广播 IP 目的地址指示了这个 IP 数据报应当由在该结点的高层协议处理，因此该数据报的载荷（一个 UDP 报文段）**被分解**向上到达 UDP，DHCP 请求报文从此 UDP 报文段中抽取出来。此时 DHCP 服务器有了 DHCP 请求报文。
5. 我们假设运行在路由器中的 DHCP 服务器能够以 **CIDR** 块 68.85.2.0/24 分配 IP 地址。所以本例中，在学校内使用的所有 IP 地址都在 Comcast 的地址块中。我们假设 DHCP 服务器分配地址 68.85.2.101 给 Bob 的便携机。DHCP 服务器生成包含这个 IP 地址以及 DNS 服务器的 IP 地址（69.85.71.226）、默认网关路由器的 IP 地址（68.85.2.1）和子网块（68.85.2.0/24）（等价为“网络掩码”）的一个 DHCP ACK **报文**。该 DHCP 报文被放入一个 UDP 报文段中，UDP 报文段被放入一个 IP 数据报中，IP 数据报再被放入一个以太网帧中。这个以太网帧的源 MAC 地址是路由器连到归属网络时接口的 MAC 地址（00:22:6B:45:1F:1B），目的 MAC 地址是 Bob 便携机的 MAC 地址（00:16:D3:23:68:8A）。
6. 包含 DHCP ACK 的以太网帧由路由器发送给交换机。因为交换机是**自学习**的，并且先前从 Bob 便携机收到（包含 DHCP 请求的）以太网帧，所以该交换机知道寻址到 00:16:D3:23:68:8A 的帧仅从通向 Bob 便携机的输出端口转发。
7. Bob 便携机接收到包含 DHCP ACK 的以太网帧，从该以太网帧中抽取 IP 数据报，从 IP 数据报中抽取 UDP 报文段，从 UDP 报文段抽取 DHCP ACK 报文。Bob 的 DHCP 客户则记录下它的 IP 地址和它的 DNS 服务器的 IP 地址。它还在其 **IP 转发表**中安装默认网关的地址。Bob 便携机将向该默认网关发送目的地址为其子网 68.85.2.0/24 以外的所有数据报。此时，Bob 便携机已经初始化好它的网络组件，并准备开始处理 Web 网页获取。

### 仍在准备：DNS 和 ARP

当 Bob 将 www.google.com 的 URL 键入其 Web 浏览器时，他开启了一长串事件，这将导致谷歌主页最终显示在其 Web 浏览器上。Bob 的 Web 浏览器通过生成一个 **TCP 套接字**开始了该过程，套接字用于向 www.google.com 发送 **HTTP 请求**。为了生成该套接字，Bob 便携机将需要知道 www.google.com 的 IP 地址。使用 **DNS 协议**提供这种名字到 IP 地址的转换服务。

8. Bob 便携机上的操作系统因此生成一个 **DNS 查询报文**，将字符串 www.google.com 放入 DNS 报文的问题段中。该 DNS 报文则放置在一个具有 53 号（DNS 服务器）目的端口的 UDP 报文段中。该 UDP 报文段则被放入具有 IP 目的地址 68.87.71.226（在第 5 步中 DHCP ACK 返回的 DNS 服务器地址）和源 IP 地址 68.85.2.101 的 IP 数据报中。
9. Bob 便携机则将包含 DNS 请求报文的数据报放入一个以太网帧中。该帧将发送（在链路层寻址）到 Bob 学校网络中的网关路由器。然而，即使 Bob 便携机经过上述第 5 步中的 DHCP ACK 报文知道了学校网关路由器的 IP 地址（68.85.2.1），但仍不知道该网关路由器的 MAC 地址。为了获得该网关路由器的 MAC 地址，Bob 便携机将需要使用 **ARP 协议**。
10. Bob 便携机生成一个具有目的 IP 地址 68.85.2.1（默认网关）的 **ARP 查询报文**，将该 ARP 报文放置在一个具有广播目的地址（FF:FF:FF:FF:FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧交付给所有连接的设备，包括网关路由器。
11. 网关路由器在通往学校网络的接口上接收到包含该 ARP 查询报文的帧，发现在 ARP 报文中目标 IP 地址 68.85.2.1 匹配其接口的 IP 地址。网关路由器因此准备一个 **ARP 回答**，指示它的 MAC 地址 00:22:6B:45:1F:1B 对应 IP 地址 68.85.2.1。它将 ARP 回答放在一个以太网帧中，其目的地址为 00:16:D3:23:68:8A（Bob 便携机），并向交换机发送该帧，再由交换机将帧交付给 Bob 便携机。
12. Bob 便携机接收包含 ARP 回答报文的帧，并从 ARP 回答报文中抽取网关路由器的 MAC 地址（00:22:6B:45:1F:1B）。
13. Bob 便携机现在能够使包含 DNS 查询的以太网帧寻址到网关路由器的 MAC 地址。注意到在该帧中的 IP 数据报具有 IP 目的地址 68.87.71.226（DNS 服务器），而该帧具有目的地址 00:22:6B:45:1F:1B（网关路由器）。Bob 便携机向交换机发送该帧，交换机将该帧交付给网关路由器。

### 仍在准备：域内路由选择到 DNS 服务器

14. 网关路由器接收该帧并抽取包含 DNS 查询的 IP 数据报。路由器查找该数据报的目的地址（68.87.71.226），并根据其转发表决定该数据报应当发送到 Comcast 网络中的最左边的路由器。IP 数据报放置在链路层帧中，该链路适合将学校路由器连接到最左边 Comcast 路由器，并且该帧经这条链路发送。
15. 在 Comcast 网络中最左边的路由器接收到该帧，抽取 IP 数据报，检查该数据报的目的地址（68.87.71.226），并根据其转发表确定出接口，经过该接口朝着 DNS 服务器转发数据报，而转发表已根据 Comcast 的域内协议（如 RIP、OSPF 或 IS-IS）以及**因特网的域间协议 BGP** 所填写。
16. 最终包含 DNS 查询的 IP 数据报到达了 DNS 服务器。DNS 服务器抽取出 DNS 查询报文，在它的 DNS 数据库中查找名字 www.google.com，找到包含对应 www.google.com 的 IP 地址（64.233.169.105）的 **DNS 源记录**。（假设它当前缓存在 DNS 服务器中。）前面讲过这种缓存数据源于 google.com 的**权威 DNS 服务器**。该 DNS 服务器形成了一个包含这种主机名到 IP 地址映射的 **DNS 回答报文**，将该 DNS 回答报文放入 UDP 报文段中，该报文段放入寻址到 Bob 便携机（68.85.2.101）的 IP 数据报中。该数据报将通过 Comcast 网络反向转发到学校的路由器，并从这里经过以太网交换机到 Bob 便携机。
17. Bob 便携机从 DNS 报文抽取出服务器 www.google.com 的 IP 地址。最终，在大量工作后，Bob 便携机此时准备接触 www.google.com 服务器！

### Web 客户 - 服务器交互：TCP 和 HTTP

18. 既然 Bob 便携机有了 www.google.com 的 IP 地址，它能够生成 **TCP 套接字**，该套接字将用于向 www.google.com 发送 **HTTP GET** 报文。当 Bob 生成 TCP 套接字时，在 Bob 便携机中的 TCP 必须首先与 www.google.com 中的 TCP 执行**三次握手**。Bob 便携机因此首先生成一个具有目的端口 80（针对 HTTP 的）的 **TCP SYN** 报文段，将该 TCP 报文段放置在具有目的 IP 地址 64.233.169.105（www.google.com）的 IP 数据报中，将该数据报放置在 MAC 地址为 00:22:6B:45:1F:1B（网关路由器）的帧中，并向交换机发送该帧。
19. 在学校网络、Comcast 网络和谷歌网络中的路由器朝着 www.google.com 转发包含 TCP SYN 的数据报，使用每台路由器中的转发表，如前面步骤 14 ~ 16 那样。前面讲过支配分组经 Comcast 和谷歌网络之间域间链路转发的路由器转发表项，是由 **BGP** 协议决定的。
20. 最终，包含 TCP SYN 的数据报到达 www.google.com。从数据报抽取出 TCP SYN 报文并分解到与端口 80 相联系的欢迎套接字。对于谷歌 HTTP 服务器和 Bob 便携机之间的 TCP 连接生成一个连接套接字。产生一个 TCP SYNACK 报文段，将其放入向 Bob 便携机寻址的一个数据报中，最后放入链路层帧中，该链路适合将 www.google.com 连接到其第一跳路由器。
21. 包含 TCP SYNACK 报文段的数据报通过谷歌、Comcast 和学校网络，最终到达 Bob 便携机的以太网卡。数据报在操作系统中分解到步骤 18 生成的 TCP 套接字，从而进入连接状态。
22. 借助于 Bob 便携机上的套接字，现在准备向 www.google.com 发送字节了，Bob 的浏览器生成包含要获取的 URL 的 HTTP GET 报文。HTTP GET 报文则写入套接字，其中 GET 报文成为一个 TCP 报文段的载荷。该 TCP 报文段放置进一个数据报中，并交付到 www.google.com，如前面 18 ~ 20 所述。
23. 在 www.google.com 的 HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 **HTTP 响应**报文，将请求的 Web 页内容放入 HTTP 响应体中，并将报文发送进 TCP 套接字中。
24. 包含 HTTP 回答报文的数据报通过谷歌、Comcast 和学校网络转发，到达 Bob 便携机。Bob 的 Web 浏览器程序从套接字读取 HTTP 响应，从 HTTP 响应体中抽取 Web 网页的 html，并终于显示了 Web 网页。

## 相关概念

### CIDR

**无分类域间路由选择**（CIDR）是在变长子网掩码的基础上提出的一种消除传统 A、B、C 类网络划分，并且可以在软件支持下实现超网构造的一种 IP 地址的划分方法。

### ARP

因为存在网络层地址（例如，因特网中的 IP 地址）和链路层地址（即 MAC 地址），所以需要在它们之间进行转换。对于因特网而言，这是**地址解析协议**（Address Resolution Protocol，ARP）的任务。

每台主机或路由器在其内存中具有一个 **ARP 表**（ARP table），这张表包含 IP 地址到 MAC 地址的映射关系。

### DHCP

**动态主机配置协议**（Dynamic Host Configuration Protocol，DHCP）常用于给主机动态地分配 IP 地址，它提供了即插即用的联网机制，这种机制允许一台计算机加入新的网络和获取 IP 地址而不用手工参与。DHCP 是应用层协议，它是基于 UDP 的。

### ICMP

**因特网控制报文协议**（ICMP）由 RFC 792 定义，被主机和路由器用来彼此沟通网络层的信息。ICMP 最典型的用途是差错报告。

ICMP 通常被认为是 IP 的一部分，但从体系结构上讲它是位于 IP 之上的，因为 ICMP 报文是承载在 IP 分组中的。ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。ICMP 是 IP 层协议。

### RIP、OSPF、BGP

**自治系统**（Autonomous System，AS），由一组通常储在相同管理控制下的路由器组成。相同的 AS 中的路由器都全部运行同样的路由选择算法，且拥有彼此的信息。在一个自治系统内运行的路由选择算法叫做**自治系统内部路由选择协议**（intra-autonomous system routing protocol）。

在一个 AS 内的一台或多台路由器将负责向在本 AS 之外的目的地转发分组。这些路由器被称为**网关路由器**（gateway router）。

AS 内部路由选择协议用于确定在一个 AS 内执行路由选择的方式。AS 内部路由选择协议又称为**内部网关协议**（interior gateway protocol）。历史上有两个路由选择协议曾被广泛用于因特网上自治系统内的路由选择：**路由选择信息协议**（Routing Information Protocol，RIP）与**开放最短路优先**（Open Shortest Path First，OSPF）。与 OSPF 密切相关的路由选择协议是 IS-IS 协议。

跨越多个 AS 的源和目的对之间是如何确定路径的？由 RFC 4271 定义的**边界网关协议**（Border Gateway Protocol，BGP）版本 4 是当今因特网中域间路由选择协议事实上的标准。它通常被称为 BGP4 或简称为 BGP。作为一个自治系统间路由选择协议，BGP 为每个 AS 提供了进行以下工作的手段：

1. 从相邻 AS 处获取子网可达性信息。
2. 向本 AS 内部的所有路由器传播这些可达性信息。
3. 基于可达性信息和 AS 策略，决定到达子网的“好”路由。

# 参考文档

- 《2022王道考研系列-计算机网络考研指导》6.2 域名系统（DNS）6.5 万维网（WWW）等
- 《计算机网络：自顶而下方法》（原书第6版）5.7 回顾：Web 页面请求的历程 等