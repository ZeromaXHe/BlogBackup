# 简答

**表空间**是 MySQL InnoDB 存储引擎中的一个概念。

从 InnoDB 存储引擎的逻辑存储结构看，所有数据都被逻辑地存放在一个空间中，称之为**表空间**（tablespace）。表空间又由段（segment）、区（extent）、页（page）组成。页在一些文档中有时也称为块（block）。

表空间可以看作是 InnoDB 存储引擎逻辑结构的最高层，所有的数据都存放在表空间中。

- 从 MySQL 5.5.7 到 MySQL 5.6.6 之间的各个版本中，我们表中的数据都会被默认存储到共享的**系统表空间** `ibdata1`，即所有数据都存放在这个表空间内。如果用户启用了参数 innodb_file_per_table，则每张表内数据可以单独放到一个**独立表空间**内。
  所谓的**系统表空间**（system tablespace）可以对应文件系统上一个或多个实际的文件，默认情况下，InnoDB 会在**数据目录**下创建一个名为 `ibdata1`、大小为 12M 的文件，这个文件就是对应的**系统表空间**在文件系统上的表示。这个文件是所谓的**自扩展文件**，也就是当不够用的时候它会自己增加文件大小。
- 在 MySQL 5.6.6 以及之后的版本中，InnoDB 并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个**独立表空间**（file-per-table tablespace），也就是说我们创建了多少个表，就有多少个独立表空间。使用**独立表空间**来存储表数据的话，会在该表所属数据库对应的子目录下创建一个表示该**独立表空间**的文件，文件名和表名相同，只不过添加了一个 .ibd 的扩展名而已，所以完整的文件名称长这样：`表名.ibd`。

如果启用了独立表空间，需要注意的是每张表的表空间内存放的只是数据、索引和插入缓冲 Bitmap 页，其他类的数据，如回滚（undo）信息，插入缓冲索引页、系统事务信息，二次写缓冲（Double write buffer）等还是存放在原来的共享的系统表空间内。这同时说明了另一个问题：即使在启用了独立表空间之后，系统表空间还是会不断地增加其大小。



随着 MySQL 的发展，除了上述两种老牌表空间之外，现在还新提出了一些不同类型的表空间，比如通用表空间（general tablespace）、undo 表空间（undo tablespace）、临时表空间（temporary tablespace）等等。

- **通用表空间**为通过 `create tablespace` 语法创建的共享表空间。通用表空间可以创建于 MySQL 数据目录外的其他表空间，其可以容纳多张表，且其支持所有的行格式。
- **undo 表空间**由一个或多个包含 undo 日志的文件组成。`innodb_undo_tablespace` 配置选项控制 undo 表空间的数目。undo 表空间创建于 `innodb_undo_directory` 配置选项确定的位置，该选项典型被用于将 undo 日志放于不同的存储设备上。如果该选项没有确定任何路径，undo 表空间则被默认创建于 MySQL 数据目录(datadir)下。
- 用户创建的临时表和磁盘内部临时表创建于共享**临时表空间**中。`innodb_temp_data_file` 选项确定临时表空间数据文件的相对路径、名字、大小和属性等。如果该选项未确定任何值，默认情况下，系统将在 `innodb_data_home_dir` 确定的目录下创建一个叫 `ibtmp1` 的自动扩展的数据文件，该文件将稍大于 12M。MySQL 服务器正常关闭或异常终止初始化时，临时表空间将被移除，并且，MySQL 服务器每次启动时会被重新创建。



不像 InnoDB 的索引和数据是一个东西，在 MyISAM 中的索引全部都是 **二级索引**，该存储引擎的数据和索引是分开存放的。所以在文件系统中也是使用不同的文件来存储数据文件和索引文件。

而且和 InnoDB 不同的是，MyISAM 并没有什么所谓的 **表空间** 一说，**表数据都存放到对应的数据库子目录下**。

# 详解

## 1 InnoDB 逻辑存储结构

从 InnoDB 存储引擎的逻辑存储结构看，所有数据都被逻辑地存放在一个空间中，称之为**表空间**（tablespace）。表空间又由段（segment）、区（extent）、页（page）组成。页在一些文档中有时也称为块（block）。

### 1.1 表空间

表空间可以看作是 InnoDB 存储引擎逻辑结构的最高层，所有的数据都存放在表空间中。

- 从 MySQL 5.5.7 到 MySQL 5.6.6 之间的各个版本中，我们表中的数据都会被默认存储到共享的**系统表空间** `ibdata1`，即所有数据都存放在这个表空间内。如果用户启用了参数 innodb_file_per_table，则每张表内数据可以单独放到一个**独立表空间**内。
- 在 MySQL 5.6.6 以及之后的版本中，InnoDB 并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个**独立表空间**，也就是说我们创建了多少个表，就有多少个独立表空间。

如果启用了独立表空间，需要注意的是每张表的表空间内存放的只是数据、索引和插入缓冲 Bitmap 页，其他类的数据，如回滚（undo）信息，插入缓冲索引页、系统事务信息，二次写缓冲（Double write buffer）等还是存放在原来的共享的系统表空间内。这同时说明了另一个问题：即使在启用了独立表空间之后，系统表空间还是会不断地增加其大小。

### 1.2 段

表空间是由各个段组成的，常见的段有数据段、索引段、回滚段等。InnoDB 存储引擎是索引组织的（index organized），因此数据即索引，索引即数据。那么数据段即为 B+ 树的叶子节点（Leaf node segment），索引段即为 B+ 树的非索引节点（Non-leaf node segment）。回滚段比较特殊，暂且不谈。

在 InnoDB 存储引擎中，对段的管理都是由引擎自身所完成，DBA 不能也没有必要对其进行控制。这和 Oracle 数据库中的自动段空间管理（ASSM）类似，从一定程度上简化了 DBA 对段的管理。

### 1.3 区

区是由连续页组成的空间，在任何情况下每个区的大小都为 1MB。为了保证区中页的连续性，InnoDB 存储引擎一次从磁盘申请 4 ~ 5 个区。在默认情况下，InnoDB 存储引擎页的大小为 16KB，即一个区中一共有 64 个连续的页。

InnoDB 1.0.x 版本开始引入压缩页，即每个页的大小可以通过参数 KEY_BLOCK_SIZE 设置为 2K、4K、8K，因此每个区对应页的数量就应该为 512、256、128。

InnoDB 1.2.x 版本新增了参数 innodb_page_size，通过该参数可以将默认页的大小设置为 4K、8K，但是页中的数据库不是压缩。这时区中页的数量同样也为 256、128。总之，不论页的大小怎么变化，区的大小总是为 1M。

但是，这里还有这样一个问题：在用户启用了独立表空间后，创建的表默认大小是 96KB。区中是 64 个连续的页，创建的表的大小至少是 1MB 才对啊？其实这是因为在每个段开始时，先用 32 个页大小的碎片页（fragment page）来存放数据，在使用完这些页之后才是 64 个连续页的申请。这样做的目的是，对于一些小表，或者是 undo 这类的段，可以在开始时申请较小的空间，节省磁盘容量的开销。

### 1.4 页

同大多数数据库一样，InnoDB 有页（Page）的概念（也可以称为块），页是 InnoDB 磁盘管理的最小单位。在 InnoDB 存储引擎中，默认每个页的大小为 16KB。而从 InnoDB 1.2.x 版本开始，可以通过参数 innodb_page_size 将页的大小设置为 4K、8K、16K。若设置完成，则所有表中页的大小都为 innodb_page_size，不可以对其再次进行修改。除非通过 mysqldump 导入和导出操作来产生新的库。

在 InnoDB 存储引擎中，常见的页类型有：

- 数据页（B-tree Node）
- undo 页（undo Log Page）
- 系统页（System Page）
- 事务数据页（Transaction system Page）
- 插入缓冲位图页（Insert Buffer Bitmap）
- 插入缓冲空闲列表页（Insert Buffer Free List）
- 未压缩的二进制大对象页（Uncompressed BLOB Page）
- 压缩的二进制大对象页（compressed BLOB Page）

### 1.5 行

InnoDB 存储引擎是面向列的（row-oriented），也就是说数据是按行进行存放的。每个页存放的行记录也是有硬性定义的，最多允许存放 16 KB / 2 - 200 行的记录，即 7992 行记录。

这里提到了 row-oriented 的数据库，也就说，存在有 column-oriented 的数据库。MySQL infobright 存储引擎就是按列来存放数据的，这对于数据仓库下的分析类 SQL 语句的执行及数据压缩非常有帮助。类似的数据库还有 Sybase IQ、Google Big Table。而面向列的数据库是当前数据库发展的一个方向。

## 2 表在文件系统中的表示

我们的数据其实都是以记录的形式插入到表中的，每个表的信息其实可以分为两种：

1. 表结构的定义
2. 表中的数据

**表结构** 就是该表的名称是什么，表里边有多少列，每个列的数据类型是什么，有什么约束条件和索引，用的是什么字符集和比较规则等等的各种信息。这些信息都体现在了我们的建表语句中了。

为了保存这些信息，InnoDB 和 MyISAM 这两种存储引擎都在 **数据目录** 下对应的数据库子目录下创建了一个专门用于描述表结构的文件，文件名是这样：`表名.frm`

比方说我们在 dahaizi 数据库下创建一个名为 test 的表。那在数据库 dahaizi 对应的子目录下就会创建一个名为 test.frm 的用于描述表结构的文件。值得注意的是，**这个后缀名为.frm的文件是以二进制格式存储的，我们直接打开会是乱码的**。

描述表结构的文件我们知道怎么存储了，那表中的数据存到了什么文件中了呢？在这个问题上，不同的存储引擎就产生分歧了，下边我们分别看一下 InnoDB 和 MyISAM 是用什么文件来保存表中数据的。

### 2.1 InnoDB 是如何存储表数据的

InnoDB 的一些实现原理：

- InnoDB 其实是使用**页**为基本单位来管理存储空间的，默认的**页**大小为 16 KB。
- 对于 InnoDB 存储引擎来说，每个索引都对应着一棵 B+ 树，该 B+ 树的每个节点都是一个数据页，数据页之间不必要是物理连续的，因为数据页之间有**双向链表**来维护着这些页的顺序。
- InnoDB 的聚簇索引的叶子节点存储了完整的用户记录，也就是所谓的**索引即数据，数据即索引**。

为了更好的管理这些页，InnoDB 的设计师们提出了一个 **表空间** 或者 **文件空间**（英文名：table space 或者 file space）的概念，这个表空间是一个抽象概念，它可以对应文件系统上一个或多个真实文件（不同表空间对应的文件数量可能不同）。每一个**表空间**可以被划分为很多很多个**页**，我们的表数据就存放在某个**表空间**下的某些页里。

InnoDB 的设计师将表空间划分为几种不同的类型。

#### 2.1.1 系统表空间（system tablespace）

所谓的**系统表空间**可以对应文件系统上一个或多个实际的文件，默认情况下，InnoDB 会在**数据目录**下创建一个名为 `ibdata1`、大小为 12M 的文件，这个文件就是对应的**系统表空间**在文件系统上的表示。这个文件是所谓的**自扩展文件**，也就是当不够用的时候它会自己增加文件大小。

当然，如果你想让系统表空间对应文件系统上多个实际文件，或者仅仅觉得原来的 `ibdata1` 这个文件名难听，那可以在 MySQL 启动时配置对应的文件路径以及它们的大小，比如我们这样修改一下配置文件：

~~~
[server]
innodb_data_file_path=data1:512M;data2:512M;autoextend
~~~

这样在 MySQL 启动之后就会创建这两个 512M 大小的文件作为 **系统表空间**，其中的 autoextend 表明这两个文件如果不够用会自动扩展 data2 文件的大小。

我们也可以把**系统表空间**对应的文件路径不配置到**数据目录**下，甚至可以配置到单独的磁盘分区上，涉及到的启动参数就是 `innodb_data_file_path` 和 `innodb_data_home_dir`。

需要注意的一点是，在一个 MySQL 服务器中，系统表空间只有一份。从 MySQL 5.5.7 到 MySQL 5.6.6 之间的各个版本中，我们表中的数据都会被默认存储到这个**系统表空间**。

#### 2.1.2 独立表空间（file-per-table tablespace）

在 MySQL 5.6.6 以及之后的版本中，InnoDB 并不会默认的把各个表的数据存储到系统表空间中，而是为每一个表建立一个独立表空间，也就是说我们创建了多少个表，就有多少个独立表空间。使用**独立表空间**来存储表数据的话，会在该表所属数据库对应的子目录下创建一个表示该**独立表空间**的文件，文件名和表名相同，只不过添加了一个 .ibd 的扩展名而已，所以完整的文件名称长这样：`表名.ibd`。

比方说假如我们使用了 **独立表空间** 去存储 xiaohaizi 数据库下的 test 表的话，那么在该表所在数据库对应的 xiaohaizi 目录下会为 test 表创建这两个文件：`test.frm`、`test.ibd`。

其中 `test.ibd` 文件就用来存储 test 表中的数据和索引。当然我们也可以自己指定使用 **系统表空间** 还是 **独立表空间** 来存储数据，这个功能由启动参数 innodb_file_per_table 控制，比如说我们想刻意将表数据都存储到 **系统表空间** 时，可以在启动 MySQL 服务器的时候这样配置：

~~~
[server]
innodb_file_per_table=0
~~~

当 innodb_file_per_table 的值为 0 时，代表使用系统表空间；当 innodb_file_per_table 的值为 1 时，代表使用独立表空间。不过 innodb_file_per_table 参数只对新建的表起作用，对于已经分配了表空间的表并不起作用。如果我们想把已经存在系统表空间的表转移到独立表空间，可以使用下边的语法：

~~~mysql
ALTER TABLE 表名 TABLESPACE [=] innodb_file_per_table;
~~~

或者把已经存在独立表空间的表转移到系统表空间，可以使用下边的语法：

~~~mysql
ALTER TABLE 表名 TABLESPACE [=] innodb_system;
~~~

其中中括号扩起来的 = 可有可无。

#### 2.1.3 其他类型的表空间

随着 MySQL 的发展，除了上述两种老牌表空间之外，现在还新提出了一些不同类型的表空间，比如通用表空间（general tablespace）、undo 表空间（undo tablespace）、临时表空间（temporary tablespace）等等。

**通用表空间**（General Tablespaces）

通用表空间为通过 `create tablespace` 语法创建的共享表空间。通用表空间可以创建于 MySQL 数据目录外的其他表空间，其可以容纳多张表，且其支持所有的行格式。通过 `create table tab_name ... tablespace [=] tablespace_name` 或 `alter table tab_name tablespace [=] tablespace_name` 语法将其添加于通用表空间内。

**undo 表空间**（undo tablespace）

undo 表空间由一个或多个包含 undo 日志的文件组成。`innodb_undo_tablespace` 配置选项控制 undo 表空间的数目。undo 表空间创建于 `innodb_undo_directory` 配置选项确定的位置，该选项典型被用于将 undo 日志放于不同的存储设备上。如果该选项没有确定任何路径，undo 表空间则被默认创建于 MySQL 数据目录(datadir)下。

**临时表空间**（Temporary Tablespace）

用户创建的临时表和磁盘内部临时表创建于共享临时表空间中。`innodb_temp_data_file` 选项确定临时表空间数据文件的相对路径、名字、大小和属性等。如果该选项未确定任何值，默认情况下，系统将在 `innodb_data_home_dir` 确定的目录下创建一个叫 `ibtmp1` 的自动扩展的数据文件，该文件将稍大于 12M。

MySQL 服务器正常关闭或异常终止初始化时，临时表空间将被移除，并且，MySQL 服务器每次启动时会被重新创建。当临时表空间被创建时，其被赋予一个动态产生的空间 ID(space ID)。如果不能创建临时表空间，

MySQL 服务器启动将被拒绝。MySQL 服务器异常终止的情况下，临时表空间将不被移除。这种情况下，DBA 能手工移除临时表空间或重启 MySQL 服务器，重启服务器过程中，将自动移除和重新创建临时表空间。

临时表空间并不能存储于裸设备。

`innodb_data_home_dir` 选项确定 InnoDB 系统表空间数据文件目录路径的共同部分。`innodb_file_per_table` 开启时，该选项设置并不影响表文件表空间的位置。该选项默认值为 MySQL 数据目录。如果你将该选项设置为空串，那么，你可以为 `innodb_data_file_path` 设置一个绝对路径值。此外，当为 `innodb_data_home_dir` 指定一个值时，需要在尾部添加一个斜杠。

### 2.2 MyISAM 是如何存储表数据的

不像 InnoDB 的索引和数据是一个东西，在 MyISAM 中的索引全部都是 **二级索引**，该存储引擎的数据和索引是分开存放的。所以在文件系统中也是使用不同的文件来存储数据文件和索引文件。

> 按照**非主键列**建立的 B+ 树需要一次**回表**操作才可以定位到完整的用户记录，这种 B+ 树被称为**二级索引**（英文名 secondary index），或者**辅助索引**、**非聚簇索引**。

而且和 InnoDB 不同的是，MyISAM 并没有什么所谓的 **表空间** 一说，**表数据都存放到对应的数据库子目录下**。

假如 test 表使用 MyISAM 存储引擎的话，那么在它所在数据库对应的 xiaohaizi 目录下会为 test 表创建这三个文件：`test.frm`、`test.MYD`、`test.MYI`。其中 `test.MYD` 代表表的数据文件，也就是我们插入的用户记录；`test.MYI` 代表表的索引文件，我们为该表创建的索引都会放到这个文件中。

# 参考文档

- 《MySQL 技术内幕：InnoDB 存储引擎》（第2版）4.2 InnoDB 逻辑存储结构
- 《MySQL 是怎样运行的：从根儿上理解 MySQL》 8.3.2 表在文件系统中的表示
- mysql通用表空间特点_浅谈mysql中各种表空间（tablespaces）的概念：https://blog.csdn.net/weixin_39644377/article/details/113642760